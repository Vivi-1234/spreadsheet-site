<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Matrix SpreadSheet</title>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-N3QK8Z3H');</script>
    <!-- End Google Tag Manager -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Ÿ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Consolas&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body{font-family:'Consolas',monospace;background:#000;color:#00ff00;margin:0;padding:0;overflow-y:auto}.matrix-rain{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:.3;pointer-events:none}header{background:rgba(0,0,0,.9);backdrop-filter:blur(5px);border-bottom:1px solid #00ff00;position:sticky;top:0;z-index:30}.nav-link{position:relative;transition:color .3s ease;color:#00ff00;font-weight:600;text-shadow:0 0 5px #00ff00;padding-bottom:2px}.nav-link:after{content:'';position:absolute;width:0;height:2px;display:block;margin-top:4px;right:0;background:#00ff00;transition:width .3s ease}.nav-link:hover:after, .nav-link.active:after{width:100%;left:0}.nav-link.active{text-shadow:0 0 8px #00ff00}.product-card{background:rgba(51,51,51,.9);border:1px solid #00ff00;transition:all .3s ease-in-out;border-radius:.5rem}.product-card:hover{transform:translateY(-10px);box-shadow:0 15px 30px -10px #00ff00;border-color:#00cc00}.product-card .img-wrapper{overflow:hidden;aspect-ratio:4/3;border-radius:.5rem .5rem 0 0}.product-card img{transition:transform .4s ease;width:100%;height:100%;object-fit:cover}.product-card:hover img{transform:scale(1.05)}@keyframes flicker-glow{0%,100%{box-shadow:0 0 4px #00ff00,inset 0 0 2px rgba(255,255,255,.4);opacity:.9}50%{box-shadow:0 0 8px #00ff00,inset 0 0 4px rgba(255,255,255,.6);opacity:1}}.discount-badge{position:absolute;top:1rem;right:1rem;background:#00ff00;color:#000;padding:.3rem .8rem;font-weight:700;font-size:.9rem;text-shadow:none;clip-path:polygon(0 0,100% 0,100% 100%,15% 100%,0 75%);animation:flicker-glow 3s infinite ease-in-out;border:1px solid #00ff00}.social-icon-bubble{transition:all .3s ease;width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);border:2px solid #00ff00}.social-icon-bubble:hover{transform:scale(1.15);box-shadow:0 0 15px #00ff00}.social-icon-image{width:100%;height:100%;object-fit:cover;border-radius:50%}.fade-in-up{opacity:0;transform:translateY(20px);transition:opacity .8s cubic-bezier(.25,.46,.45,.94),transform .8s cubic-bezier(.25,.46,.45,.94)}.fade-in-up.visible{opacity:1;transform:translateY(0)}.filter-btn{padding:.5rem 1.25rem;border:1px solid #00ff00;color:#00ff00;background:0 0;transition:all .3s ease;border-radius:9999px;cursor:pointer}.filter-btn:hover{background:rgba(0,255,0,.1);box-shadow:0 0 8px #00ff00}.filter-btn.active{background:#00ff00;color:#000;text-shadow:none}.brand-dropdown{position:relative}.brand-dropdown-menu{display:none;position:absolute;top:100%;right:0;background:rgba(0,0,0,.95);border:1px solid #00ff00;border-radius:.5rem;z-index:40;min-width:150px;margin-top:.5rem}.brand-dropdown.active .brand-dropdown-menu{display:block}.brand-dropdown-item{padding:.75rem 1rem;cursor:pointer}.brand-dropdown-item:hover{background:#00ff00;color:#000}.text-shadow-glow{text-shadow:0 0 8px rgba(255,255,255,.8),0 0 12px rgba(0,255,0,.6)}.timer-box{display:flex;flex-direction:column;align-items:center;background:rgba(0,0,0,.7);padding:.25rem .5rem;border:1px solid #00ff00;min-width:60px}.timer-value{font-size:1.5rem;line-height:1.2;font-weight:700}.timer-label{font-size:.6rem;text-transform:uppercase;letter-spacing:.05em;margin-top:.1rem;opacity:.7}
        .product-title {height: 3em;line-height: 1.5em;display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;}
        @media (min-width: 768px) { .social-icon-bubble{width:56px;height:56px} .timer-box{padding:.5rem 1rem;min-width:80px} .timer-value{font-size:2.5rem;line-height:1} .timer-label{font-size:.8rem;letter-spacing:.1em;margin-top:.25rem} }
    </style>
</head>
<body class="text-[#00FF00] antialiased">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N3QK8Z3H"height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <canvas class="matrix-rain"></canvas>
    <div id="social-icons-container" class="fixed right-0 top-1/2 -translate-y-1/2 z-40 flex flex-col items-center space-y-2 md:space-y-4 mr-2 md:mr-8"></div>

    <header>
        <div class="container mx-auto px-4 md:px-12 py-4 flex justify-between items-center">
            <a href="/" class="text-xl md:text-2xl font-bold tracking-tighter text-[#00FF00] text-shadow-glow">Matrix SpreadSheet</a>
            <div id="main-nav" class="flex items-center space-x-8"></div>
        </div>
    </header>

    <main class="container mx-auto px-4 md:px-12">
        
        <section id="flash-sale-section" class="hidden my-12 md:my-16 fade-in-up">
            <div class="relative w-full p-4 md:p-6 border-2 border-[#00FF00] shadow-[0_0_15px_#00FF00] bg-black bg-opacity-50">
                <div class="flex flex-col items-center justify-center text-center">
                    <h2 class="text-3xl md:text-5xl font-bold tracking-widest text-white text-shadow-glow">FLASH SALE</h2>
                    <p class="mt-2 text-base md:text-lg text-[#00FF00]">ENDING IN</p>
                    <div id="countdown-timer" class="flex gap-2 md:gap-8 mt-4 text-white"></div>
                </div>
                <div id="flash-sale-product-list" class="mt-8 grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-x-12 md:gap-y-14"></div>
            </div>
        </section>

        <section id="info-section" class="my-12 md:my-20 fade-in-up" style="transition-delay: 100ms;">
            <div class="text-center">
                <h1 id="site-title" class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-[#00FF00] tracking-tighter leading-tight text-shadow-glow"></h1>
                <p id="site-subtitle" class="mt-4 md:mt-6 text-base md:text-lg text-[#00FF00] max-w-xl mx-auto opacity-80"></p>
            </div>
        </section>

        <section id="product-section" class="pt-10 md:pt-16 fade-in-up" style="transition-delay: 200ms;">
            <div id="category-filter-container" class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8 md:mb-12"></div>
            <div id="product-list-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-x-12 md:gap-y-14"></div>
        </section>
        
    </main>

    <footer class="bg-transparent mt-20 md:mt-28">
        <div class="container mx-auto px-4 md:px-12 py-10 md:py-14 text-center">
            <p class="font-bold text-lg md:text-xl mb-4 text-[#00FF00]">Matrix SpreadSheet</p>
            <p class="text-sm md:text-base text-[#00FF00] opacity-60 max-w-lg mx-auto">A community dedicated to discovering Mulebuy's finest goods. Join us to find your next perfect pair.</p>
            <div class="mt-8 pt-8 md:mt-10 md:pt-10 border-t border-[#00FF00] opacity-40 text-xs md:text-sm">
                <p>Â© 2025 Matrix SpreadSheet. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        const SUPABASE_URL = 'https://xfkattyyvnbmgnqqsvms.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhma2F0dHl5dm5ibWducXFzdm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjYzNzQsImV4cCI6MjA2NjQ0MjM3NH0.z21tfMKKMYB66juOKIYui2uRM5xUjRE_VisNJcxCsWw';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let allProducts = [], currentCategoryFilter = 'all', currentBrandFilter = 'all';
        let cnyToUsdRate = 0.14, userCountryCode = null;

        const urlParams = new URLSearchParams(window.location.search);
        const refId = urlParams.get('ref');

        async function logEvent(eventType, eventValue = null) {
            try {
                const { error } = await db.from('analytics_events').insert([{ event_type: eventType, event_value: eventValue, ref_id: refId, country_code: userCountryCode }]);
                if (error) console.error('Analytics event logging failed:', error);
            } catch (error) { console.error('Error in logEvent:', error); }
        }
        
        function appendRefParam(url) {
            if (!refId || !url) return url;
            try {
                const urlObj = new URL(url);
                if (!urlObj.searchParams.has('ref')) urlObj.searchParams.append('ref', refId);
                return urlObj.toString();
            } catch(e) { return url; }
        }
        
        function renderProducts(containerId, productArray) {
            const productContainer = document.getElementById(containerId);
            if (!productContainer) return;
            
            productContainer.innerHTML = '';
            if (productArray.length > 0) {
                productArray.forEach(p => {
                    const now = new Date();
                    const expiry = p.discount_expires_at ? new Date(p.discount_expires_at) : null;
                    const showDiscount = p.discount_is_active && p.discount_price && (!expiry || expiry > now);
                    const usdPrice = (p.price * cnyToUsdRate).toFixed(2);
                    const usdDiscountPrice = p.discount_price ? (p.discount_price * cnyToUsdRate).toFixed(2) : null;
                    let priceHTML = `<p class="font-bold text-lg md:text-xl text-[#00FF00] mt-2">$${usdPrice}</p>`;
                    if (showDiscount && usdDiscountPrice) {
                        priceHTML = `<p class="font-bold text-lg md:text-xl text-red-500 mt-2">$${usdDiscountPrice} <span class="text-base text-[#00FF00] opacity-60 font-normal line-through ml-2">$${usdPrice}</span></p>`;
                    }
                    let discountBadgeHTML = '';
                    if (showDiscount && p.discount_factor) {
                        const percentageOff = Math.round((1 - p.discount_factor) * 100);
                        if (percentageOff > 0) discountBadgeHTML = `<div class="discount-badge">${percentageOff}% OFF</div>`;
                    }
                    productContainer.innerHTML += `<a href="${appendRefParam(p.target_url)}" target="_blank" data-product-name="${p.name}" class="group block product-card relative"><div class="img-wrapper"><img src="${p.image_url || 'https://placehold.co/400x300/000000/00FF00?text=NO+IMAGE'}" alt="${p.name}" class="w-full h-full object-cover"></div><div class="p-3 pt-2 pb-3 md:p-4 md:pt-3 md:pb-4"><h3 class="product-title font-semibold text-base md:text-lg text-[#00FF00] group-hover:text-[#00CC00] transition-colors">${p.name}</h3>${priceHTML}</div>${discountBadgeHTML}</a>`;
                });
            } else {
                productContainer.innerHTML = `<p class="text-center text-[#00FF00] opacity-60 text-lg col-span-full">No products in this section.</p>`;
            }
        }
        
        function applyFiltersAndRender() {
            let filteredProducts = allProducts;
            const params = new URLSearchParams(window.location.search);
            const brandFromUrl = params.get('brand');

            if (brandFromUrl) {
                currentBrandFilter = brandFromUrl;
            }

            if (currentCategoryFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category && p.category.split(',').map(c => c.trim()).includes(currentCategoryFilter));
            }
            if (currentBrandFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.brand_id == currentBrandFilter);
            }
            renderProducts('product-list-container', filteredProducts);
        }

        async function loadAndRender() {
            try {
                try {
                    const rateResponse = await fetch('https://api.frankfurter.app/latest?from=CNY&to=USD');
                    if (rateResponse.ok) { cnyToUsdRate = (await rateResponse.json()).rates.USD; }
                } catch (rateError) { console.error('Error fetching exchange rate:', rateError); }

                const [settingsRes, navRes, socialRes, productsRes, brandsRes, flashSaleSettingsRes, flashSaleProductsRes] = await Promise.all([
                    db.from('settings').select('*').limit(1).single(),
                    db.from('navigation').select('*').order('display_order'),
                    db.from('social_links').select('*').order('display_order'),
                    db.from('products').select(`*, brands (*)`).eq('is_active', true).order('display_order'),
                    db.from('brands').select('*').order('name'),
                    db.from('flash_sale_settings').select('*').single(),
                    db.from('flash_sale_products').select('*, products(*, brands(*))').order('display_order')
                ]);

                allProducts = productsRes.data || [];
                const settings = settingsRes.data;
                const navItems = navRes.data || [];
                const socialLinks = socialRes.data;
                const brands = brandsRes.data || [];
                const flashSaleSettings = flashSaleSettingsRes.data;
                const flashSaleProducts = (flashSaleProductsRes.data || []).map(item => item.products).filter(Boolean);

                if (settings) {
                    document.title = "Products - " + (settings.site_title || 'Matrix SpreadSheet');
                    const siteTitleEl = document.getElementById('site-title');
                    const siteSubtitleEl = document.getElementById('site-subtitle');
                    if (siteTitleEl) siteTitleEl.innerHTML = (settings.site_title || 'Matrix SpreadSheet').replace('Next', '<br>Next');
                    if (siteSubtitleEl) siteSubtitleEl.textContent = settings.site_subtitle || 'Discover the Matrix';
                }
                
                const mainNavContainer = document.getElementById('main-nav');
                if (mainNavContainer) {
                    const howToBuyLink = `<a href="/" class="nav-link">How-to-buy</a>`;
                    const productsLink = `<a href="/products" class="nav-link active">Products</a>`;
                    const brandDropdownHTML = `<div class="brand-dropdown"><button class="nav-trigger text-lg font-medium flex items-center gap-2 text-[#00FF00] hover:text-white transition-colors duration-300"><i data-lucide="list-filter" class="w-6 h-6 md:w-auto md:h-auto"></i><span class="nav-link text-base md:text-lg">Brands</span></button><div class="brand-dropdown-menu"><div class="brand-dropdown-item" data-brand="all">All Brands</div>${brands.map(brand => `<div class="brand-dropdown-item" data-brand="${brand.id}">${brand.name}</div>`).join('')}</div></div>`;
                    mainNavContainer.innerHTML = howToBuyLink + productsLink + brandDropdownHTML;
                }

                const socialContainer = document.getElementById('social-icons-container');
                if (socialContainer && socialLinks) {
                    socialContainer.innerHTML = ''; 
                    socialLinks.forEach(link => {
                        const iconElement = link.icon_url ? `<img src="${link.icon_url}" alt="${link.platform_name} logo" class="social-icon-image">` : `<i data-lucide="${link.icon_svg_name || 'link'}" style="color: ${link.icon_color || '#00FF00'};"></i>`;
                        let finalUrl = link.link_url || '#';
                        if (finalUrl !== '#' && !finalUrl.startsWith('http')) finalUrl = `https://${finalUrl}`;
                        socialContainer.innerHTML += `<a href="${finalUrl}" target="_blank" class="social-icon-bubble">${iconElement}</a>`;
                    });
                }
                
                const categoryFilterContainer = document.getElementById('category-filter-container');
                if (categoryFilterContainer) {
                    let filterHTML = '<button class="filter-btn active" data-category="all">All</button>';
                    const validNavItems = navItems.filter(item => item.link_text && item.link_text.toLowerCase() !== 'home');
                    filterHTML += validNavItems.map(link => `<button class="filter-btn" data-category="${link.link_text}">${link.link_text}</button>`).join('');
                    categoryFilterContainer.innerHTML = filterHTML;
                }
                
                const flashSaleSection = document.getElementById('flash-sale-section');
                if (flashSaleSettingsRes.error === null && flashSaleSettings?.is_active && flashSaleSettings.end_time) {
                    const endTime = new Date(flashSaleSettings.end_time);
                    if (endTime > new Date()) {
                        flashSaleSection.classList.remove('hidden');
                        setupCountdown(endTime);
                        renderProducts('flash-sale-product-list', flashSaleProducts);
                    }
                }
                
                applyFiltersAndRender();
            } catch (error) {
                console.error('Error loading page data:', error);
                document.querySelector('main').innerHTML = `<p class="text-center text-red-500 text-lg col-span-full">A critical error occurred. Could not load page content. Please check console for details.</p>`;
            }

            lucide.createIcons();
            
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const card = e.target.closest('.product-card');
                if (card?.dataset.productName) logEvent('product_click', card.dataset.productName);
            });
            
            const categoryContainer = document.getElementById('category-filter-container');
            categoryContainer?.addEventListener('click', e => {
                const button = e.target.closest('.filter-btn');
                if (button) {
                    categoryContainer.querySelector('.active')?.classList.remove('active');
                    button.classList.add('active');
                    currentCategoryFilter = button.dataset.category;
                    applyFiltersAndRender();
                }
            });
            
            const brandDropdown = document.querySelector('.brand-dropdown');
            if (brandDropdown) {
                const trigger = brandDropdown.querySelector('.nav-trigger');
                const menu = brandDropdown.querySelector('.brand-dropdown-menu');
                trigger?.addEventListener('click', e => { e.stopPropagation(); brandDropdown.classList.toggle('active'); });
                menu?.addEventListener('click', e => {
                    const item = e.target.closest('.brand-dropdown-item');
                    if(item) {
                        currentBrandFilter = item.dataset.brand;
                        const selectedText = item.textContent;
                        const triggerTextSpan = trigger.querySelector('.nav-link');
                        if(triggerTextSpan) {
                           triggerTextSpan.textContent = selectedText === 'All Brands' ? 'Brands' : selectedText;
                        }
                        applyFiltersAndRender();
                        brandDropdown.classList.remove('active');
                    }
                });
            }

            document.addEventListener('click', e => {
                const brandDropdown = document.querySelector('.brand-dropdown');
                if (brandDropdown && !brandDropdown.contains(e.target)) {
                    brandDropdown.classList.remove('active');
                }
            });
        }
        
        function setupCountdown(targetDate) {
            const timerContainer = document.getElementById('countdown-timer');
            if(!timerContainer) return;
            timerContainer.innerHTML = `<div class="timer-box"><span id="days" class="timer-value">00</span><span class="timer-label">Days</span></div><div class="timer-box"><span id="hours" class="timer-value">00</span><span class="timer-label">Hours</span></div><div class="timer-box"><span id="minutes" class="timer-value">00</span><span class="timer-label">Minutes</span></div><div class="timer-box"><span id="seconds" class="timer-value">00</span><span class="timer-label">Seconds</span></div>`;
            const daysEl = document.getElementById('days'), hoursEl = document.getElementById('hours'), minutesEl = document.getElementById('minutes'), secondsEl = document.getElementById('seconds');
            if (!daysEl) return;
            const countdownInterval = setInterval(() => {
                const distance = targetDate - new Date().getTime();
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    timerContainer.innerHTML = '<div class="text-2xl font-bold text-red-500">SALE ENDED</div>';
                    return;
                }
                daysEl.textContent = String(Math.floor(distance / 864e5)).padStart(2, '0');
                hoursEl.textContent = String(Math.floor((distance % 864e5) / 36e5)).padStart(2, '0');
                minutesEl.textContent = String(Math.floor((distance % 36e5) / 6e4)).padStart(2, '0');
                secondsEl.textContent = String(Math.floor((distance % 6e4) / 1e3)).padStart(2, '0');
            }, 1000);
        }

        function initMatrixRain() {
            const canvas = document.querySelector('.matrix-rain');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ', fontSize = 14, columns = canvas.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);
            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#00FF00';
                ctx.font = fontSize + 'px Consolas';
                for (let i = 0; i < drops.length; i++) {
                    const text = chars.charAt(Math.floor(Math.random() * chars.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            }
            setInterval(draw, 33);
        }

        async function initGeoAndLog() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (response.ok) userCountryCode = (await response.json()).country_code || 'Unknown';
                else userCountryCode = 'API Error';
            } catch (error) {
                console.error('Could not fetch geolocation data:', error);
                userCountryCode = 'Network Error';
            } finally {
                logEvent('site_visit'); 
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMatrixRain();
            loadAndRender();
            initGeoAndLog();
        });
    </script>
</body>
</html>
