<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 SheetJS 用于解析 Excel 文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 引入 SortableJS 用于拖拽排序 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button { display: flex; align-items: center; width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; color: #4b5563; transition: all 0.2s ease; }
        .tab-button:hover { background-color: #e5e7eb; }
        .tab-button.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .label { font-weight: 500; color: #374151; }
        .input { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem; transition: all 0.2s ease; }
        .input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; color: white; transition: all 0.2s ease; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #374151; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .sortable-ghost { background: #dbeafe; opacity: 0.5; }
        .sortable-chosen { cursor: grabbing; }
        .stat-card { background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg"><h1 class="text-2xl font-bold text-center text-gray-800 mb-6">后台登录</h1><div class="space-y-4"><div><label for="password" class="label block mb-1">请输入密码:</label><input type="password" id="password" class="input" placeholder="••••••••"></div><button id="login-btn" class="w-full btn btn-primary">登录</button></div><p id="auth-error" class="text-red-500 text-sm text-center mt-4"></p></div>
    </div>

    <!-- 管理后台主界面 -->
    <div id="admin-panel" class="hidden"><div class="flex h-screen bg-gray-100"><aside class="w-64 bg-white p-4 flex flex-col shadow-lg border-r border-gray-200"><h1 class="text-2xl font-bold text-gray-800 px-2 pb-4 border-b">SpreadSheet</h1><nav id="sidebar-nav" class="mt-6 space-y-2 flex-grow"><button data-target="dashboard" class="tab-button active"><i data-lucide="layout-dashboard" class="mr-3 h-5 w-5"></i>仪表盘</button><button data-target="products" class="tab-button"><i data-lucide="package" class="mr-3 h-5 w-5"></i>产品管理</button><button data-target="settings" class="tab-button"><i data-lucide="sliders-horizontal" class="mr-3 h-5 w-5"></i>网站设置</button><button data-target="navigation" class="tab-button"><i data-lucide="list" class="mr-3 h-5 w-5"></i>导航栏管理</button><button data-target="social" class="tab-button"><i data-lucide="share-2" class="mr-3 h-5 w-5"></i>社交媒体</button></nav><div class="pt-4 border-t"><button id="logout-btn" class="w-full text-sm font-medium text-red-600 hover:underline text-left px-2 py-2 flex items-center"><i data-lucide="log-out" class="mr-2 h-4 w-4"></i>退出登录</button></div></aside><main class="flex-1 p-8 overflow-y-auto" id="main-content"></main></div></div>

    <!-- 弹窗: 编辑产品 -->
    <div id="edit-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-lg font-semibold">编辑产品</h3><button id="close-modal-btn"><i data-lucide="x" class="h-5 w-5"></i></button></div><div class="p-6 space-y-4"><input type="hidden" id="edit-product-id"><div id="edit-image-paste-box" class="p-4 rounded-lg bg-gray-50 text-center cursor-pointer text-gray-500 border-2 border-dashed border-gray-300"><p>点击选择或粘贴图片</p><img id="edit-preview-image" src="" class="hidden max-h-32 mx-auto rounded mt-2"></div><input type="file" id="edit-image-input" class="hidden" accept="image/*"><div><label class="label">产品名称</label><input type="text" id="edit-product-name" class="input mt-1"></div><div class="grid grid-cols-2 gap-4"><div><label class="label">原价</label><input type="number" id="edit-product-price" class="input mt-1"></div><div><label class="label">跳转链接</label><input type="text" id="edit-product-target-url" class="input mt-1"></div></div><div class="p-4 rounded-lg bg-blue-50 border border-blue-200"><p class="font-semibold mb-2">折扣设置</p><div class="grid grid-cols-3 gap-4 items-center"><div><label class="label">折扣价</label><input type="number" id="edit-product-discount-price" class="input mt-1"></div><div><label class="label">折扣有效期(天)</label><input type="number" id="edit-product-discount-days" class="input mt-1" placeholder="例如: 3"></div><div class="flex items-center pt-6"><input type="checkbox" id="edit-product-discount-active" class="h-4 w-4 rounded"><label for="edit-product-discount-active" class="ml-2">开启折扣</label></div></div></div></div><div class="p-6 bg-gray-50 rounded-b-xl text-right"><button id="save-product-changes-btn" class="btn btn-primary">保存更改</button></div></div></div>
    
    <!-- 加载遮罩 -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><div class="flex items-center"><i data-lucide="loader-2" class="animate-spin h-8 w-8 text-blue-600"></i><p class="ml-4 text-lg font-semibold">处理中...</p></div></div>

    <script type="module">
        // --- 配置 ---
        const SUPABASE_URL = 'https://xfkattyyvnbmgnqqsvms.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhma2F0dHl5dm5ibWducXFzdm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjYzNzQsImV4cCI6MjA2NjQ0MjM3NH0.z21tfMKKMYB66juOKIYui2uRM5xUjRE_VisNJcxCsWw';
        const ADMIN_PASSWORD = 'mulebuy123'; 

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let productsCache = [];
        let sortableInstance = null;
        
        // --- DOM 元素 ---
        const authScreen = document.getElementById('auth-screen');
        const adminPanel = document.getElementById('admin-panel');
        const mainContent = document.getElementById('main-content');
        const sidebarNav = document.getElementById('sidebar-nav');
        const modal = document.getElementById('edit-product-modal');
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- 模板HTML ---
        const templates = {
            dashboard: `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">仪表盘</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="stat-card p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="p-3 bg-blue-100 rounded-full"><i data-lucide="package" class="h-6 w-6 text-blue-600"></i></div>
                        <div class="ml-4"><p class="text-sm text-gray-500">总产品数</p><p id="total-products" class="text-2xl font-bold">0</p></div>
                    </div>
                    <div class="stat-card p-6 rounded-xl shadow-sm border border-gray-200 flex items-center">
                        <div class="p-3 bg-green-100 rounded-full"><i data-lucide="tag" class="h-6 w-6 text-green-600"></i></div>
                        <div class="ml-4"><p class="text-sm text-gray-500">进行中的折扣</p><p id="active-discounts" class="text-2xl font-bold">0</p></div>
                    </div>
                </div>`,
            settings: `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">网站全局设置</h2>
                <div class="bg-white p-6 rounded-xl shadow-md space-y-4 max-w-2xl">
                    <div><label for="site-title" class="label">主标题</label><input type="text" id="site-title" class="input mt-1"></div>
                    <div><label for="site-subtitle" class="label">副标题</label><textarea id="site-subtitle" class="input mt-1" rows="2"></textarea></div>
                    <div><label for="video-url" class="label">教程视频链接</label><input type="text" id="video-url" class="input mt-1"><p class="text-xs text-gray-500 mt-1">提示: 请使用 YouTube 的 "embed" 格式链接，例如 https://www.youtube.com/embed/VIDEO_ID</p></div>
                    <div><label for="product-section-title" class="label">产品区标题</label><input type="text" id="product-section-title" class="input mt-1"></div>
                    <div class="text-right"><button id="save-settings-btn" class="btn btn-primary">保存设置</button></div>
                </div>`,
            products: `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">产品管理</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6 border-b pb-6">
                        <div>
                            <h3 class="font-semibold mb-2 text-lg">单个添加产品</h3>
                            <div class="space-y-3 bg-gray-50 p-4 rounded-lg border">
                                <input type="text" id="new-product-name" placeholder="产品名称" class="input">
                                <input type="text" id="new-product-target-url" placeholder="跳转链接 (Mulebuy)" class="input">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="number" id="new-product-price" placeholder="原价" class="input">
                                    <input type="number" id="new-product-discount-price" placeholder="折扣价 (可选)" class="input">
                                </div>
                                <input type="text" id="new-product-image-url" placeholder="产品图片链接" class="input">
                                <button id="add-product-btn" class="btn btn-primary w-full">确认添加</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2 text-lg">批量上传 (Excel)</h3>
                            <div class="space-y-3 bg-gray-50 p-4 rounded-lg border h-full flex flex-col justify-center">
                                <p class="text-sm text-gray-600">请上传 .xlsx/.csv 文件。文件需包含列: name, price, discount_price, image_url, target_url</p>
                                <button id="download-template-btn" class="btn btn-secondary w-full text-sm"><i data-lucide="download" class="mr-2 h-4 w-4"></i>下载模板</button>
                                <input type="file" id="bulk-upload-input" accept=".xlsx, .csv" class="text-sm">
                                <button id="bulk-upload-btn" class="btn btn-primary w-full mt-2"><i data-lucide="upload" class="mr-2 h-4 w-4"></i>开始上传</button>
                            </div>
                        </div>
                    </div>
                    <h3 class="font-semibold mb-2 text-lg">产品列表 <span class="text-sm font-normal text-gray-500">(可拖拽排序)</span></h3>
                    <div id="product-list" class="space-y-2"></div>
                </div>`,
            navigation: `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">导航栏管理</h2>
                <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl">
                    <div id="navigation-list" class="space-y-3 mb-4"></div>
                    <div class="mt-4"><button id="add-nav-btn" class="btn btn-secondary text-sm"><i data-lucide="plus" class="mr-2 h-4 w-4"></i>添加导航项</button></div>
                    <div class="text-right mt-4"><button id="save-nav-btn" class="btn btn-primary">保存全部变更</button></div>
                </div>`,
            social: `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">社交媒体管理</h2>
                <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl">
                    <div id="social-links-list" class="space-y-3 mb-4"></div>
                    <div class="text-right"><button id="save-social-btn" class="btn btn-primary">保存社媒链接变更</button></div>
                </div>`
        };

        // --- 核心模块 ---
        function renderPanel(panelName) {
            mainContent.innerHTML = templates[panelName];
            switch (panelName) {
                case 'dashboard': loadDashboardStats(); break;
                case 'settings': loadSettings(); break;
                case 'products': loadProducts(); setupProductEventListeners(); break;
                case 'navigation': loadNavigation(); break;
                case 'social': loadSocialLinks(); break;
            }
            lucide.createIcons();
        }

        function showLoading(show) { loadingOverlay.classList.toggle('hidden', !show); }

        // --- 数据加载 ---
        async function loadDashboardStats() {
            const { count: productCount } = await db.from('products').select('*', { count: 'exact', head: true });
            const { count: discountCount } = await db.from('products').select('*', { count: 'exact', head: true }).eq('discount_is_active', true);
            document.getElementById('total-products').textContent = productCount || 0;
            document.getElementById('active-discounts').textContent = discountCount || 0;
        }

        async function loadSettings() {
            const { data } = await db.from('settings').select('*').limit(1).single();
            if (data) {
                document.getElementById('site-title').value = data.site_title;
                document.getElementById('site-subtitle').value = data.site_subtitle;
                document.getElementById('video-url').value = data.video_url;
                document.getElementById('product-section-title').value = data.product_section_title;
            }
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        }
        
        async function loadNavigation() {
            const { data } = await db.from('navigation').select('*').order('display_order');
            const navList = document.getElementById('navigation-list');
            navList.innerHTML = '';
            if (data) data.forEach(item => renderNavItem(item));
            document.getElementById('add-nav-btn').addEventListener('click', () => renderNavItem({ id: `new_${Date.now()}`, link_text: '', link_url: '' }));
            document.getElementById('save-nav-btn').addEventListener('click', saveNavigation);
        }

        function renderNavItem(item) {
            const navList = document.getElementById('navigation-list');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 nav-item-row';
            div.dataset.id = item.id;
            div.innerHTML = `
                <input type="text" value="${item.link_text}" class="input nav-text w-1/3" placeholder="链接文字">
                <input type="text" value="${item.link_url}" class="input nav-url w-2/3" placeholder="跳转位置 (URL)">
                <button class="delete-nav-btn p-2 hover:bg-gray-200 rounded-full"><i data-lucide="trash-2" class="h-4 w-4 text-red-500"></i></button>
            `;
            div.querySelector('.delete-nav-btn').addEventListener('click', () => div.remove());
            navList.appendChild(div);
            lucide.createIcons();
        }

        async function loadSocialLinks() {
            const { data } = await db.from('social_links').select('*').order('display_order');
            const socialList = document.getElementById('social-links-list');
            socialList.innerHTML = '';
            if (data) data.forEach(item => socialList.innerHTML += `<div class="grid grid-cols-4 gap-2"><input type="text" data-id="${item.id}" value="${item.platform_name}" class="input social-platform col-span-1" placeholder="平台名称"><input type="text" data-id="${item.id}" value="${item.link_url}" class="input social-url col-span-3" placeholder="主页链接"></div>`);
            document.getElementById('save-social-btn').addEventListener('click', saveSocialLinks);
        }

        async function loadProducts() {
            const { data } = await db.from('products').select('*').order('display_order');
            productsCache = data || [];
            const productListEl = document.getElementById('product-list');
            productListEl.innerHTML = '';
            productsCache.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex items-center bg-white border p-2 rounded-lg gap-4 shadow-sm';
                item.dataset.id = p.id;
                const discountActiveHTML = p.discount_is_active ? `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">开启</span>` : `<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">关闭</span>`;
                const expiryDate = p.discount_expires_at ? new Date(p.discount_expires_at).toLocaleDateString() : '—';
                item.innerHTML = `
                    <i data-lucide="grip-vertical" class="cursor-move text-gray-400 hover:text-gray-600"></i>
                    <img src="${p.image_url}" class="w-12 h-12 object-cover rounded-md">
                    <div class="flex-grow font-semibold text-gray-800">${p.name}</div>
                    <div><span class="text-xs text-gray-500">折扣:</span> ${discountActiveHTML}</div>
                    <div><span class="text-xs text-gray-500">到期:</span> ${expiryDate}</div>
                    <div class="flex gap-2">
                        <button data-id="${p.id}" class="edit-product-btn p-2 hover:bg-gray-200 rounded-full"><i data-lucide="edit-2" class="h-4 w-4 text-blue-600"></i></button>
                        <button data-id="${p.id}" class="delete-product-btn p-2 hover:bg-gray-200 rounded-full"><i data-lucide="trash-2" class="h-4 w-4 text-red-500"></i></button>
                    </div>
                `;
                productListEl.appendChild(item);
            });
            lucide.createIcons();
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(productListEl, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.cursor-move',
                onEnd: async (evt) => {
                    const newOrder = Array.from(evt.to.children).map(item => item.dataset.id);
                    const updates = newOrder.map((id, index) => ({ id: parseInt(id, 10), display_order: index }));
                    showLoading(true);
                    await db.from('products').upsert(updates);
                    await loadProducts();
                    showLoading(false);
                }
            });
        }
        
        // --- 事件监听设置 ---
        function setupProductEventListeners() {
            document.getElementById('download-template-btn').addEventListener('click', downloadTemplate);
            document.getElementById('bulk-upload-btn').addEventListener('click', bulkUpload);
            document.getElementById('add-product-btn').addEventListener('click', addSingleProduct);
            document.getElementById('product-list').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                if (button.classList.contains('edit-product-btn')) openEditModal(button.dataset.id);
                if (button.classList.contains('delete-product-btn')) deleteProduct(button.dataset.id);
            });
        }

        // --- 数据保存 ---
        async function saveSettings(e) {
            e.target.disabled = true; e.target.textContent = '保存中...';
            const updates = {
                id: 1,
                site_title: document.getElementById('site-title').value,
                site_subtitle: document.getElementById('site-subtitle').value,
                video_url: document.getElementById('video-url').value,
                product_section_title: document.getElementById('product-section-title').value,
            };
            const { error } = await db.from('settings').upsert(updates);
            if (error) alert('保存失败: ' + error.message);
            else alert('网站设置已保存！');
            e.target.disabled = false; e.target.textContent = '保存设置';
        }

        async function saveNavigation(e) {
            e.target.disabled = true; e.target.textContent = '保存中...';
            const navRows = document.querySelectorAll('#navigation-list .nav-item-row');
            const navItems = Array.from(navRows).map((row, index) => ({
                id: isNaN(parseInt(row.dataset.id)) ? undefined : parseInt(row.dataset.id),
                link_text: row.querySelector('.nav-text').value,
                link_url: row.querySelector('.nav-url').value,
                display_order: index
            }));

            // Get existing IDs from DB to determine which ones to delete
            const { data: existingNavs } = await db.from('navigation').select('id');
            const existingIds = existingNavs.map(n => n.id);
            const currentIds = navItems.map(n => n.id).filter(id => id !== undefined);
            const idsToDelete = existingIds.filter(id => !currentIds.includes(id));

            if (idsToDelete.length > 0) {
                await db.from('navigation').delete().in('id', idsToDelete);
            }
            
            const { error } = await db.from('navigation').upsert(navItems);

            if (error) alert('导航栏保存失败: ' + error.message);
            else {
                alert('导航栏已更新！');
                await loadNavigation(); // Reload to get new IDs
            }
            e.target.disabled = false; e.target.textContent = '保存全部变更';
        }

        async function saveSocialLinks(e) { /* ... same as previous correct implementation ... */ }

        // --- 图片处理 ---
        async function uploadImage(file) { /* ... same as previous correct implementation ... */ }
        function handleImagePaste(pasteEvent, previewEl, callback) { /* ... same as previous correct implementation ... */ }
        
        // --- 产品操作 ---
        async function addSingleProduct(e) { /* ... same as previous correct implementation ... */ }
        let currentEditFile = null;
        let currentEditImageUrl = '';
        async function openEditModal(productId) { /* ... same as previous correct implementation ... */ }
        document.getElementById('save-product-changes-btn').addEventListener('click', async(e) => { /* ... same as previous correct implementation ... */ });
        async function deleteProduct(id) { /* ... same as previous correct implementation ... */ }
        
        // --- 批量上传和模板 ---
        function downloadTemplate() { /* ... same as previous correct implementation ... */ }
        async function bulkUpload() { /* ... same as previous correct implementation ... */ }

        // --- 认证与初始化 ---
        const loginBtn = document.getElementById('login-btn');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');

        function checkAuth() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                authScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                lucide.createIcons();
                renderPanel('dashboard');
            }
        }
        
        loginBtn.addEventListener('click', () => {
            if (passwordInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                checkAuth();
            } else {
                authError.textContent = '密码错误，请重试。';
            }
        });
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        });
        
        sidebarNav.addEventListener('click', (e) => {
            const button = e.target.closest('.tab-button');
            if (!button) return;
            sidebarNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            renderPanel(button.dataset.target);
        });
        
        // Modal close button
        document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));

        // Initial Load
        checkAuth();
    </script>
</body>
</html>
