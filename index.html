<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 标题将由JS动态填充 -->
    <title>SpreadSheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Manrope', 'Inter', sans-serif; background-color: #ffffff; }
        .nav-link { position: relative; transition: color 0.3s ease; }
        .nav-link:after { content: ''; position: absolute; width: 0; height: 1.5px; display: block; margin-top: 4px; right: 0; background: #111827; transition: width 0.3s ease; }
        .nav-link:hover:after { width: 100%; left: 0; }
        .product-card { background-color: #ffffff; border: 1px solid #f0f0f0; transition: all 0.3s ease-in-out; }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px -5px #1118271a; border-color: #e5e7eb; }
        .product-card .img-wrapper { 
            overflow: hidden;
            aspect-ratio: 1 / 1; /* 确保图片容器是正方形 */
        }
        .product-card img { 
            transition: transform 0.4s ease;
            width: 100%;
            height: 100%;
            object-fit: cover; /* 确保图片覆盖整个容器，不变形 */
        }
        .product-card:hover img { transform: scale(1.05); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1rem; background-color: #e5e7eb; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .social-icon-bubble { transition: transform 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .social-icon-bubble:hover { transform: scale(1.1); }
        .fade-in-up { opacity: 0; transform: translateY(20px); transition: opacity 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .fade-in-up.visible { opacity: 1; transform: translateY(0); }
        .discount-badge { position: absolute; top: 1rem; right: 1rem; background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .category-page { padding-top: 2rem; }
        /* 自定义社交图标样式 */
        .telegram-icon { fill: #0088cc; }
        .reddit-icon { fill: #ff4500; }
        .discord-icon { fill: #7289da; }
    </style>
</head>
<body class="text-neutral-800 antialiased">
    <!-- 浮动社交媒体图标 -->
    <div id="social-icons-container" class="fixed right-0 top-1/2 -translate-y-1/2 z-40 flex flex-col items-center space-y-3 mr-2 md:mr-4"></div>

    <!-- 导航栏 -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-30 border-b border-neutral-200/70">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="https://spreadsheet-site.vercel.app/" class="text-xl font-bold tracking-tighter text-neutral-900">SpreadSheet</a>
            <nav id="navigation-container" class="hidden md:flex items-center space-x-10"></nav>
            <button class="md:hidden"><i data-lucide="menu" class="w-6 h-6 text-neutral-600"></i></button>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-6">
        <!-- 英雄区 -->
        <section id="hero-section" class="grid grid-cols-1 lg:grid-cols-2 gap-x-16 gap-y-10 items-center my-12 md:my-16 fade-in-up">
            <div class="text-center lg:text-left">
                <h1 id="site-title" class="text-4xl md:text-5xl font-extrabold text-neutral-900 tracking-tighter leading-tight"></h1>
                <p id="site-subtitle" class="mt-4 text-neutral-500 max-w-lg mx-auto lg:mx-0 text-base"></p>
                <div class="mt-6 max-w-sm mx-auto lg:mx-0 relative"><i data-lucide="search" class="w-4 h-4 text-neutral-400 absolute left-4 top-1/2 -translate-y-1/2"></i><input type="text" placeholder="Search brands, styles, and more" class="w-full bg-neutral-100/70 border border-transparent rounded-lg py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"></div>
            </div>
            <div class="w-full"><div id="video-wrapper" class="video-container shadow-xl shadow-neutral-200/80"></div></div>
        </section>

        <!-- 产品展示区 -->
        <section id="product-section" class="pt-8 md:pt-12 fade-in-up" style="transition-delay: 200ms;">
            <h2 id="product-section-title" class="text-2xl font-bold text-center mb-10 tracking-tight"></h2>
            <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-8"></div>
        </section>

        <!-- 分类页面 -->
        <section id="category-section" class="category-page hidden">
            <h2 id="category-title" class="text-2xl font-bold text-center mb-10 tracking-tight capitalize"></h2>
            <div id="category-product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-8"></div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white mt-24 border-t border-neutral-200/70"><div class="container mx-auto px-6 py-12 text-center"><p class="font-bold text-lg mb-3">SpreadSheet</p><p class="text-neutral-500 text-sm max-w-md mx-auto">一个致力于发现和推荐 Mulebuy 优质好物的社区。加入我们，发现你的下一双心动好鞋。</p><div class="mt-8 pt-8 border-t border-neutral-200/70 text-xs text-neutral-400"><p>© 2024 SpreadSheet. All Rights Reserved.</p></div></footer>

    <script type="module">
        const SUPABASE_URL = 'https://xfkattyyvnbmgnqqsvms.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhma2F0dHl5dm5ibWducXFzdm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjYzNzQsImV4cCI6MjA2NjQ0MjM3NH0.z21tfMKKMYB66juOKIYui2uRM5xUjRE_VisNJcxCsWw';
        const BASE_URL = 'https://spreadsheet-site.vercel.app/';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 官方社交图标 SVG
        const socialIcons = {
            'telegram': `<svg class="telegram-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.65 7.85l-6.5 6.5c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-3.5-3.5c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l2.29 2.29 5.29-5.29c.39-.39 1.02-.39 1.41 0s.4 1.02 0 1.41z"/></svg>`,
            'reddit': `<svg class="reddit-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#ff4500"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2zm0 3h2v5h-2zm-1 7h4v2h-4z" fill="#fff"/></svg>`,
            'discord': `<svg class="discord-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.885-1.5152.0741.0741 0 00-.0783.0371c-.2119.3755-.4791.7342-.7882 1.0606a18.7506 18.7506 0 00-5.6936 0 12.7212 12.7212 0 00-.7882-1.0606.0776.0776 0 00-.0783-.0372 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.3203 13.5799.0992 18.0578a.0778.0778 0 00.0365.0457c.9066 1.1176 2.3072 1.8277 3.875 2.1534a.0853.0853 0 00.0906-.1454c-.3765-.2523-.7172-.5318-1.0138-.8408a.0745.0745 0 01-.0155-.0897 11.5816 11.5816 0 016.9456-2.0136.0778.0778 0 01.0783.038c.4971.8357 1.04 1.607 1.6281 2.3058a.0749.0749 0 00.1125.0266c1.616-1.156 2.8913-2.4058 3.7923-3.7107a.077.077 0 01.0848-.0298c1.0853.4068 2.1882.7148 3.2972.931a.0745.0745 0 00.0866-.0583 12.1038 12.1038 0 00.6726-3.2973.0778.0778 0 00-.0305-.0638 19.6552 19.6552 0 00-1.7186-1.3886 12.6841 12.6841 0 01-4.0968-.5985.0776.0776 0 00-.0783-.0371c-.8126.1676-1.6159.298-2.4216.3815a.0778.0778 0 00-.0583.041c-.5138.6812-1.0696 1.3082-1.6431 1.8867a.0739.0739 0 01-.1066.0128c-1.3128-.9096-2.43-1.9556-3.3037-3.1198a.076.076 0 01.0266-.1066c1.2022-1.1746 2.1883-2.5488 2.917-4.0746a.0778.0778 0 00-.0186-.0947 18.1882 18.1882 0 011.9475-1.6592.0745.0745 0 00.0321-.0277zM9.5663 15.3438c-1.0133 0-1.8428.8205-1.8428 1.8281s.8295 1.8281 1.8428 1.8281 1.8428-.8205 1.8428-1.8281-.8295-1.8281-1.8428-1.8281zm5.8672 0c-1.0133 0-1.8428.8205-1.8428 1.8281s.8295 1.8281 1.8428 1.8281 1.8428-.8205 1.8428-1.8281-.8294-1.8281-1.8428-1.8281z" fill="#7289da"/></svg>`
        };

        // --- 数据加载和渲染 ---
        async function loadAndRender() {
            const [settingsRes, navRes, socialRes, productsRes] = await Promise.all([
                db.from('settings').select('*').limit(1).single(),
                db.from('navigation').select('*').order('display_order'),
                db.from('social_links').select('*').order('display_order'),
                db.from('products').select('*').eq('is_active', true).order('display_order')
            ]);

            // 渲染全局设置
            const settings = settingsRes.data;
            const siteTitle = document.getElementById('site-title');
            const siteSubtitle = document.getElementById('site-subtitle');
            const productSectionTitle = document.getElementById('product-section-title');
            const videoWrapper = document.getElementById('video-wrapper');
            const categoryTitle = document.getElementById('category-title');
            if (settings) {
                document.title = settings.site_title;
                if (siteTitle) siteTitle.innerHTML = settings.site_title.replace('Next', '<br>Next');
                if (siteSubtitle) siteSubtitle.textContent = settings.site_subtitle;
                if (productSectionTitle) productSectionTitle.textContent = settings.product_section_title;
                if (videoWrapper) videoWrapper.innerHTML = `<iframe src="${settings.video_url}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            }

            // 渲染导航栏
            const navigation = navRes.data;
            const navContainer = document.getElementById('navigation-container');
            if (navContainer) {
                navContainer.innerHTML = '<a href="' + BASE_URL + '" class="nav-link text-sm font-medium text-neutral-500 hover:text-neutral-900">Home</a>';
                if (navigation) {
                    navigation.forEach(link => {
                        if (link.link_text.toLowerCase() !== 'home') {
                            navContainer.innerHTML += `<a href="${formatUrl(link.link_text.toLowerCase())}" class="nav-link text-sm font-medium text-neutral-500 hover:text-neutral-900">${link.link_text}</a>`;
                        }
                    });
                }
            }

            // 渲染社交图标
            const socialLinks = socialRes.data;
            const socialContainer = document.getElementById('social-icons-container');
            if (socialContainer) {
                socialContainer.innerHTML = '';
                if (socialLinks) {
                    socialLinks.forEach(link => {
                        const platform = link.platform_name.toLowerCase();
                        const icon = socialIcons[platform] || `<i data-lucide="link" class="w-5 h-5 text-white"></i>`; // 备用图标
                        socialContainer.innerHTML += `
                            <a href="${formatUrl(link.link_url)}" target="_blank" class="social-icon-bubble w-11 h-11 flex items-center justify-center rounded-full shadow-md" style="background-color: ${link.icon_color || '#333'};" title="${link.platform_name}">
                                ${icon}
                            </a>`;
                    });
                }
            }

            // 渲染产品列表
            const products = productsRes.data;
            const productContainer = document.getElementById('product-list-container');
            const categoryProductList = document.getElementById('category-product-list');
            if (productContainer && categoryProductList) {
                productContainer.innerHTML = '';
                categoryProductList.innerHTML = '';
                const path = window.location.pathname.replace(/^\//, '').toLowerCase() || 'index.html';
                console.log('Current path:', path); // 调试日志
                if (products) {
                    products.forEach(p => {
                        const now = new Date();
                        const expiry = p.discount_expires_at ? new Date(p.discount_expires_at) : null;
                        const showDiscount = p.discount_is_active && p.discount_price && (!expiry || expiry > now);

                        let priceHTML = `<p class="font-bold text-lg text-neutral-900 mt-1">¥${p.price}</p>`;
                        if (showDiscount) {
                            priceHTML = `<p class="font-bold text-lg text-red-600 mt-1">¥${p.discount_price} <span class="text-sm text-gray-400 font-normal line-through ml-1">¥${p.price}</span></p>`;
                        }

                        const productCard = `
                            <a href="${formatUrl(p.target_url)}" target="_blank" class="group block rounded-xl product-card relative">
                                <div class="img-wrapper rounded-t-xl"><img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover"></div>
                                <div class="p-4">
                                    <h3 class="font-semibold text-base text-neutral-800 truncate group-hover:text-blue-600 transition-colors">${p.name}</h3>
                                    ${priceHTML}
                                </div>
                                ${showDiscount ? '<div class="discount-badge">折扣</div>' : ''}
                            </a>
                        `;

                        // 首页显示所有产品
                        if (path === 'index.html' || path === '') {
                            productContainer.innerHTML += productCard;
                        }
                        // 分类页面显示匹配的分类产品
                        const categories = p.category ? p.category.split(',').map(cat => cat.trim().toLowerCase()) : [];
                        console.log('Product:', p.name, 'Categories:', categories); // 调试日志
                        const navCategories = navigation ? navigation.filter(item => item.link_text.toLowerCase() !== 'home').map(item => item.link_text.toLowerCase()) : [];
                        console.log('Nav Categories:', navCategories); // 调试日志
                        if (navCategories.includes(path)) {
                            if (categories.some(cat => navCategories.includes(cat))) {
                                categoryProductList.innerHTML += productCard;
                                if (categoryTitle) categoryTitle.textContent = navigation.find(item => item.link_text.toLowerCase() === path)?.link_text || path.charAt(0).toUpperCase() + path.slice(1);
                            }
                        }
                    });

                    // 显示对应部分
                    const heroSection = document.getElementById('hero-section');
                    const productSection = document.getElementById('product-section');
                    const categorySection = document.getElementById('category-section');
                    if (heroSection && productSection && categorySection) {
                        if (path === 'index.html' || path === '') {
                            heroSection.classList.remove('hidden');
                            productSection.classList.remove('hidden');
                            categorySection.classList.add('hidden');
                        } else {
                            heroSection.classList.add('hidden');
                            productSection.classList.add('hidden');
                            categorySection.classList.remove('hidden');
                        }
                    }
                }
            }

            lucide.createIcons();
            // 渲染淡入动画
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
        }

        // --- 初始化 ---
        loadAndRender();
        setInterval(loadAndRender, 30000); // 每30秒轮询一次
    </script>
</body>
</html>
