<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpreadSheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Manrope', 'Inter', sans-serif; background-color: #ffffff; }
        .nav-link { position: relative; transition: color 0.3s ease; }
        .nav-link:after { content: ''; position: absolute; width: 0; height: 1.5px; display: block; margin-top: 4px; right: 0; background: #111827; transition: width 0.3s ease; }
        .nav-link:hover:after { width: 100%; left: 0; }
        .product-card { background-color: #ffffff; border: 1px solid #f0f0f0; transition: all 0.3s ease-in-out; }
        .product-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px -10px #1118271a !important; border-color: #e5e7eb; }
        .product-card .img-wrapper { overflow: hidden; aspect-ratio: 4 / 3; }
        .product-card img { transition: transform 0.4s ease; width: 100%; height: 100%; object-fit: cover; }
        .product-card:hover img { transform: scale(1.05); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1.5rem; background-color: #e5e7eb; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .social-icon-bubble { transition: all 0.3s ease; width: 14px; height: 14px; border-radius: 9999px; display: flex; } /* 56px x 56px */
        .social-icon-bubble:hover { transform: scale(1.15) !important; box-shadow: 0 8px 12px -4px rgba(0, 0, 0, 0.1), 0 3px 6px -2px rgba(0, 0, 0, 0.05) !important; }
        .fade-in-up { opacity: 0; transform: translateY(20px); transition: opacity 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .fade-in-up.visible { opacity: 1; transform: translateY(0); }
        .discount-badge { position: absolute; top: 1.5rem; right: 1.5rem; background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
        .social-icon-image { width: 56px; height: 56px; object-fit: cover; max-width: 100% !important; max-height: 100% !important; } /* 56px x 56px */
    </style>
</head>
<body class="text-neutral-800 antialiased">
    <div id="social-icons-container" class="fixed right-0 top-1/2 -translate-y-1/2 z-40 flex flex-col items-center space-y-2 mr-6 md:mr-8"></div>

    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-30 border-b border-neutral-200/70">
        <div class="container mx-auto px-12 py-6 flex justify-between items-center">
            <a href="https://spreadsheet-site.vercel.app/" class="text-2xl font-bold tracking-tighter text-neutral-900">SpreadSheet</a>
            <nav id="navigation-container" class="hidden md:flex items-center space-x-12"></nav>
            <button class="md:hidden"><i data-lucide="menu" class="w-7 h-7 text-neutral-600"></i></button>
        </div>
    </header>

    <main class="container mx-auto px-12">
        <section id="hero-section" class="grid grid-cols-1 lg:grid-cols-2 gap-x-20 gap-y-12 items-center my-16 md:my-20 fade-in-up">
            <div class="text-center lg:text-left">
                <h1 id="site-title" class="text-5xl md:text-6xl font-extrabold text-neutral-900 tracking-tighter leading-tight"></h1>
                <p id="site-subtitle" class="mt-6 text-neutral-500 max-w-xl mx-auto lg:mx-0 text-lg"></p>
                <div class="mt-8 max-w-xl mx-auto lg:mx-0 relative"><i data-lucide="search" class="w-5 h-5 text-neutral-400 absolute left-5 top-1/2 -translate-y-1/2"></i><input type="text" placeholder="Search brands, styles, and more" class="w-full bg-neutral-100/70 border border-transparent rounded-xl py-4 pl-12 pr-6 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"></div>
            </div>
            <div class="w-full"><div id="video-wrapper" class="video-container shadow-xl shadow-neutral-200/80"></div></div>
        </section>

        <section id="product-section" class="pt-10 md:pt-16 fade-in-up" style="transition-delay: 200ms;">
            <h2 id="product-section-title" class="text-3xl font-bold text-center mb-12 tracking-tight"></h2>
            <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-12 gap-y-14"></div>
        </section>

        <section id="category-section" class="category-page hidden">
            <h2 id="category-title" class="text-3xl font-bold text-center mb-12 tracking-tight capitalize"></h2>
            <div id="category-product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-12 gap-y-14"></div>
        </section>
    </main>

    <footer class="bg-white mt-28 border-t border-neutral-200/70">
        <div class="container mx-auto px-12 py-14 text-center">
            <p class="font-bold text-xl mb-4">SpreadSheet</p>
            <p class="text-neutral-500 text-base max-w-lg mx-auto">一个致力于发现和推荐 Mulebuy 优质好物的社区。加入我们，发现你的下一双心动好鞋。</p>
            <div class="mt-10 pt-10 border-t border-neutral-200/70 text-sm text-neutral-400">
                <p>© 2024 SpreadSheet. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        const SUPABASE_URL = 'https://xfkattyyvnbmgnqqsvms.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhma2F0dHl5dm5ibWducXFzdm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjYzNzQsImV4cCI6MjA2NjQ0MjM3NH0.z21tfMKKMYB66juOKIYui2uRM5xUjRE_VisNJcxCsWw';
        const BASE_URL = 'https://spreadsheet-site.vercel.app/';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 辅助函数：修复URL ---
        function formatUrl(url) {
            if (!url) return '#';
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            return `${BASE_URL}${url}`;
        }

        // --- 数据加载和渲染 ---
        async function loadAndRender() {
            try {
                const [settingsRes, navRes, socialRes, productsRes] = await Promise.all([
                    db.from('settings').select('*').limit(1).single(),
                    db.from('navigation').select('*').order('display_order'),
                    db.from('social_links').select('*').order('display_order'),
                    db.from('products').select('*').eq('is_active', true).order('display_order')
                ]);

                // 渲染全局设置
                const settings = settingsRes.data;
                const siteTitle = document.getElementById('site-title');
                const siteSubtitle = document.getElementById('site-subtitle');
                const productSectionTitle = document.getElementById('product-section-title');
                const videoWrapper = document.getElementById('video-wrapper');
                const categoryTitle = document.getElementById('category-title');
                if (settings) {
                    document.title = settings.site_title || 'SpreadSheet';
                    if (siteTitle) siteTitle.innerHTML = (settings.site_title || 'SpreadSheet').replace('Next', '<br>Next');
                    if (siteSubtitle) siteSubtitle.textContent = settings.site_subtitle || 'Discover great products';
                    if (productSectionTitle) productSectionTitle.textContent = settings.product_section_title || 'Featured Products';
                    if (videoWrapper) {
                        const videoUrl = settings.video_url ? settings.video_url.replace('watch?v=', 'embed/').split('&')[0] : '';
                        videoWrapper.innerHTML = videoUrl ? `<iframe src="${videoUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>` : '';
                    }
                }

                // 渲染导航栏
                const navigation = navRes.data;
                console.log('Navigation data:', navigation); // 调试日志
                const navContainer = document.getElementById('navigation-container');
                if (navContainer) {
                    navContainer.innerHTML = '<a href="' + BASE_URL + '" class="nav-link text-sm font-medium text-neutral-500 hover:text-neutral-900">Home</a>';
                    if (navigation) {
                        const validNavItems = navigation.filter(item => item.link_text && item.link_text.toLowerCase() !== 'home');
                        if (validNavItems.length > 0) {
                            validNavItems.forEach(link => {
                                navContainer.innerHTML += `<a href="${formatUrl(link.link_text.toLowerCase())}" class="nav-link text-sm font-medium text-neutral-500 hover:text-neutral-900">${link.link_text}</a>`;
                            });
                        } else {
                            console.warn('No valid navigation items found except Home');
                        }
                    } else {
                        console.warn('No navigation data available');
                    }
                }

                // 渲染社交图标
                const socialLinks = socialRes.data;
                const socialContainer = document.getElementById('social-icons-container');
                if (socialContainer) {
                    socialContainer.innerHTML = '';
                    if (socialLinks) {
                        socialLinks.forEach(link => {
                            const iconElement = link.icon_url 
                                ? `<img src="${link.icon_url}" alt="${link.platform_name} logo" class="social-icon-image">` 
                                : `<i data-lucide="${link.icon_svg_name || 'link'}" style="color: ${link.icon_color || '#333'};"></i>`;
                            socialContainer.innerHTML += `
                                <a href="${formatUrl(link.link_url)}" target="_blank" class="social-icon-bubble w-14 h-14 flex items-center justify-center rounded-full shadow-md" style="background-color: ${link.icon_color || '#333'};">
                                    ${iconElement}
                                </a>`;
                        });
                    } else {
                        console.warn('No social links data available');
                    }
                }

                // 渲染产品列表
                const products = productsRes.data;
                const productContainer = document.getElementById('product-list-container');
                const categoryProductList = document.getElementById('category-product-list');
                if (productContainer && categoryProductList) {
                    productContainer.innerHTML = '';
                    categoryProductList.innerHTML = '';
                    const path = window.location.pathname.replace(/^\//, '').toLowerCase() || 'index.html';
                    console.log('Current path:', path);
                    if (products) {
                        products.forEach(p => {
                            const now = new Date();
                            const expiry = p.discount_expires_at ? new Date(p.discount_expires_at) : null;
                            const showDiscount = p.discount_is_active && p.discount_price && (!expiry || expiry > now);

                            let priceHTML = `<p class="font-bold text-xl text-neutral-900 mt-2">¥${p.price}</p>`;
                            if (showDiscount) {
                                priceHTML = `<p class="font-bold text-xl text-red-600 mt-2">¥${p.discount_price} <span class="text-base text-gray-400 font-normal line-through ml-2">¥${p.price}</span></p>`;
                            }

                            const productCard = `
                                <a href="${formatUrl(p.target_url)}" target="_blank" class="group block rounded-xl product-card relative">
                                    <div class="img-wrapper rounded-t-xl"><img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover"></div>
                                    <div class="p-8">
                                        <h3 class="font-semibold text-lg text-neutral-800 truncate group-hover:text-blue-600 transition-colors">${p.name}</h3>
                                        ${priceHTML}
                                    </div>
                                    ${showDiscount ? '<div class="discount-badge">折扣</div>' : ''}
                                </a>
                            `;

                            if (path === 'index.html' || path === '') {
                                productContainer.innerHTML += productCard;
                            }
                            const categories = p.category ? p.category.split(',').map(cat => cat.trim().toLowerCase()) : [];
                            const navCategories = navigation ? navigation.filter(item => item.link_text.toLowerCase() !== 'home' && !['sale', 'discount', '折扣'].includes(item.link_text.toLowerCase())).map(item => item.link_text.toLowerCase()) : [];
                            if (navCategories.includes(path)) {
                                if (categories.some(cat => navCategories.includes(cat))) {
                                    categoryProductList.innerHTML += productCard;
                                    if (categoryTitle) categoryTitle.textContent = navigation.find(item => item.link_text.toLowerCase() === path)?.link_text || path.charAt(0).toUpperCase() + path.slice(1);
                                }
                            }
                        });
                    } else {
                        productContainer.innerHTML = '<p class="text-center text-gray-500 text-lg">No products available.</p>';
                        categoryProductList.innerHTML = '<p class="text-center text-gray-500 text-lg">No products in this category.</p>';
                    }

                    const heroSection = document.getElementById('hero-section');
                    const productSection = document.getElementById('product-section');
                    const categorySection = document.getElementById('category-section');
                    if (heroSection && productSection && categorySection) {
                        if (path === 'index.html' || path === '') {
                            heroSection.classList.remove('hidden');
                            productSection.classList.remove('hidden');
                            categorySection.classList.add('hidden');
                        } else {
                            heroSection.classList.add('hidden');
                            productSection.classList.add('hidden');
                            categorySection.classList.remove('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error('Error in loadAndRender:', error);
                document.getElementById('product-list-container').innerHTML = '<p class="text-center text-red-500 text-lg">加载数据失败，请稍后重试。</p>';
                document.getElementById('category-product-list').innerHTML = '<p class="text-center text-red-500 text-lg">加载数据失败，请稍后重试。</p>';
            }

            lucide.createIcons();
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
        }

        // --- 初始化 ---
        loadAndRender();
        setInterval(loadAndRender, 30000); // 每30秒轮询一次
    </script>
</body>
</html>
